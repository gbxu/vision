
SHELL_FOLDER=$(cd "$(dirname "$0")";pwd)
cd $SHELL_FOLDER/..

declare -A dic
dic=(["alexnet"]=4096 ["densenet121"]=128 ["densenet169"]=128 ["densenet161"]=128 ["densenet201"]=128 ["resnet18"]=2048 ["resnet34"]=1024 ["resnet50"]=512 ["resnet101"]=256 ["resnet152"]=256 ["squeezenet1_0"]=512 ["squeezenet1_1"]=1024 ["vgg11"]=256 ["vgg13"]=256 ["vgg16"]=256 ["vgg19"]=256 ["wide_resnet50_2"]=512 ["wide_resnet101_2"]=256 )

mkdir testonnxs
cd testonnxs
for model_name in "alexnet" "densenet121" "densenet161" "densenet169" "densenet201" "resnet18" "resnet34" "resnet50" "resnet101" "resnet152" "squeezenet1_0" "squeezenet1_1" "vgg11" "vgg13" "vgg16" "vgg19" "wide_resnet50_2" "wide_resnet101_2"
do
    python3 ../classification2onnx.py --model_name $model_name --batch_size ${dic[$model_name]}
done
cd ..

mkdir testmodels
cd testmodels
for model_name in "alexnet" "densenet121" "densenet161" "densenet169" "densenet201" "resnet18" "resnet34" "resnet50" "resnet101" "resnet152" "squeezenet1_0" "squeezenet1_1" "vgg11" "vgg13" "vgg16" "vgg19" "wide_resnet50_2" "wide_resnet101_2"
do
    f="../testonnxs/"${model_name}".onnx"
    echo ${model_name}", batch:"${dic[$model_name]}
    mkdir ${model_name}_bs${dic[$model_name]}
    # CURR_DIR=${f#*/}
    rm -rf ${model_name}_bs${dic[$model_name]}/dp_cudalib
    ${HOME}/nnfusion/build/src/tools/nnfusion/nnfusion $f \
    -f onnx -p "batch:${dic[$model_name]}" \
    -ftraining_mode=true -fautodiff=true -ftraining_optimizer="{\"optimizer\":\"SGD\",\"learning_rate\":0.01}" \
    -fblockfusion_level=0 -fenable_all_bert_fusion=true -fkernel_fusion_level=2 \
    -frun_step=50 \
    -fextern_result_memory=true \
    -min_log_level=0 > ${model_name}_bs${dic[$model_name]}_log 2>&1
    mv nnfusion_rt ${model_name}_bs${dic[$model_name]}/dp_cudalib
done
cd ..

declare -A ALLREDUCE_FUSION_BUCKET_DIC
ALLREDUCE_FUSION_BUCKET_DIC=(\
    ["alexnet"]="0,1;2,3,4,5;6;7" \
    ["densenet121"]="0,1,2,3,4,5,6,7,8,9,10;11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118;119,120" \
    ["densenet161"]="0,1,2,3,4,5;6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71;72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105;106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132" \
    ["densenet169"]="0,1,2,3,4,5,6,7,8,9,10;11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109;110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168" \
    ["densenet201"]="0,1,2,3,4,5,6,7,8,9,10;11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113;114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163;164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200" \
    ["resnet18"]="0,1,2,3,4,5,6;7,8,9,10,11,12,13,14,15,16,17,18;19,20" \
    ["resnet34"]="0,1,2,3,4,5,6,7;8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26;27,28,29,30,31,32;33,34,35;36" \
    ["resnet50"]="0,1,2,3,4,5,6,7,8,9,10,11,12;13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38;39,40,41,42,43,44,45,46;47,48,49,50,51;52,53" \
    ["resnet101"]="0,1,2,3,4,5,6,7,8,9,10,11,12;13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38;39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56;57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74;75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92;93,94,95,96,97,98;99,100,101,102;103,104" \
    ["resnet152"]="0,1,2,3,4,5,6,7,8,9,10,11,12;13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47;48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65;66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83;84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101;102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119;120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137;138,139,140,141,142,143,144,145,146,147,148;149,150,151,152,153;154,155" \
    ["squeezenet1_0"]="0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17;18,19,20,21,22,23,24,25" \
    ["squeezenet1_1"]="0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18;19,20,21,22,23,24,25" \
    ["vgg11"]="0,1,2;3,4,5,6,7;8;9;10" \
    ["vgg13"]="0,1,2,3,4;5,6,7,8,9;10;11;12" \
    ["vgg16"]="0,1,2,3,4;5,6,7,8,9;10,11,12;13;14;15" \
    ["vgg19"]="0,1,2,3,4;5,6,7,8,9,10;11,12,13;14,15,16;17;18" \
    ["wide_resnet50_2"]="0,1,2,3,4,5,6;7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26;27,28,29,30,31,32;33,34,35,36,37,38;39,40,41,42,43,44;45,46,47,48;49,50,51;52,53" \
    ["wide_resnet101_2"]="0,1,2,3,4,5,6;7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26;27,28,29,30,31,32;33,34,35,36,37,38;39,40,41,42,43,44;45,46,47,48,49,50;51,52,53,54,55,56;57,58,59,60,61,62;63,64,65,66,67,68;69,70,71,72,73,74;75,76,77,78,79,80;81,82,83,84,85,86;87,88,89,90,91,92;93,94,95;96,97,98,99;100,101,102;103,104" \
)

mkdir testmodels
cd testmodels
for model_name in "alexnet" "densenet121" "densenet161" "densenet169" "densenet201" "resnet18" "resnet34" "resnet50" "resnet101" "resnet152" "squeezenet1_0" "squeezenet1_1" "vgg11" "vgg13" "vgg16" "vgg19" "wide_resnet50_2" "wide_resnet101_2"
do
    ALLREDUCE_FUSION_BUCKET_LIST=${ALLREDUCE_FUSION_BUCKET_DIC[$model_name]}
    echo $ALLREDUCE_FUSION_BUCKET_LIST
    f="../testonnxs/"${model_name}".onnx"
    echo ${model_name}", batch:"${dic[$model_name]}
    mkdir ${model_name}_bs${dic[$model_name]}
    # CURR_DIR=${f#*/}
    rm -rf ${model_name}_bs${dic[$model_name]}/dp_cudalib
    ${HOME}/nnfusion/build/src/tools/nnfusion/nnfusion $f \
    -f onnx -p "batch:${dic[$model_name]}" \
    -ftraining_mode=true -fautodiff=true -ftraining_optimizer="{\"optimizer\":\"SGD\",\"learning_rate\":0.01}" \
    -fblockfusion_level=0 -fenable_all_bert_fusion=true -fkernel_fusion_level=2 \
    -frun_step=50 \
    -sc_allreduce_fusion_list=${ALLREDUCE_FUSION_BUCKET_LIST} \
    -fadd_sc_allreduce=true -fadd_sc_allreduce_fusion=true -sc_allreduce_fusion_size=6553600 \
    -fextern_result_memory=true \
    -min_log_level=0 > ${model_name}_bs${dic[$model_name]}_log 2>&1
    mv nnfusion_rt ${model_name}_bs${dic[$model_name]}/dp_cudalib
done
cd ..
